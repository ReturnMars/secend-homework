# 数据库持久化需求规范

## 概述

将 AI 对话系统从内存存储迁移到 PostgreSQL 数据库，支持会话持久化、Artifact 管理、用户数据存储等功能。

---

## 1. 核心需求

### 1.1 会话持久化 (REQ-DB-001)

**描述**: 用户与 AI 的对话历史必须持久化存储，服务重启后可恢复。

**验收标准**:
- [ ] 服务重启后，用户可继续之前的对话
- [ ] 对话历史支持跨设备/浏览器访问（基于 session_id）
- [ ] 单会话支持 50+ 轮对话
- [ ] 系统支持万级会话存储

### 1.2 消息管理 (REQ-DB-002)

**描述**: 支持消息的增删改查及软删除。

**验收标准**:
- [ ] 消息创建时自动记录时间戳
- [ ] 支持消息编辑（保留编辑历史）
- [ ] 支持软删除（deleted_at 字段）
- [ ] 消息按时间顺序正确排列

### 1.3 Artifact 结构化存储 (REQ-DB-003)

**描述**: AI 生成的代码组件（Artifact）需独立存储，支持查询和版本控制。

**验收标准**:
- [ ] Artifact 与消息分离存储，通过外键关联
- [ ] 存储 Artifact 元数据（identifier, title, type）
- [ ] 支持版本控制（同一 identifier 的多次迭代）
- [ ] 可按 identifier 或 title 查询 Artifact

### 1.4 用户数据存储 (REQ-DB-004)

**描述**: 用户上传的数据集（JSON/CSV）持久化存储。

**验收标准**:
- [ ] 支持存储 JSON 格式数据（JSONB 字段）
- [ ] 支持存储 CSV 解析后的数据
- [ ] 数据集与会话关联
- [ ] 单数据集支持 ≤50MB

---

## 2. 非功能需求

### 2.1 性能

| 指标 | 要求 |
|------|------|
| 消息写入延迟 | < 50ms |
| 历史加载延迟 | < 200ms (50条消息) |
| 并发会话数 | ≥ 100 |

### 2.2 可扩展性

- 预留 pgvector 向量存储扩展点
- 数据模型支持未来用户认证扩展
- 支持未来迁移到对象存储（用户数据）

### 2.3 可维护性

- 使用 Alembic 管理数据库版本
- 所有表包含审计字段（created_at, updated_at, deleted_at）

---

## 3. 暂不实现

以下功能在本阶段不实现，但数据模型需预留扩展点：

- [ ] 用户认证系统
- [ ] 用户对 Artifact 的反馈（点赞/修改请求）
- [ ] 数据源连接信息存储
- [ ] 向量存储实现（仅预留 pgvector 扩展）
- [ ] 实时数据分析

---

## 4. 术语定义

| 术语 | 定义 |
|------|------|
| Session | 一次完整的对话会话，包含多条消息 |
| Message | 单条对话消息（用户或 AI） |
| Artifact | AI 生成的代码组件，嵌入在 AI 消息中 |
| Dataset | 用户上传的数据集（JSON/CSV） |
