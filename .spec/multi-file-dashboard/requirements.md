# 多文件 Dashboard 架构 - 需求规格

## 1. 项目背景

### 1.1 当前问题

单文件 Dashboard 生成模式存在以下痛点：

| 问题 | 影响 |
|------|------|
| 命名冲突 | 多组件需要 `_` 前缀，AI 容易忘记或写错 |
| 代码冗长 | 单文件上千行，LLM 输出容易截断或出错 |
| 调试困难 | 错误定位困难，无法快速找到问题组件 |
| 代码重复 | `COLORS` 等常量在每个组件中重复定义 |
| 牵一发动全身 | 单个组件语法错误导致整个看板崩溃 |

### 1.2 目标

实现 **多文件 Dashboard 架构**，将每个组件拆分为独立文件：

```
/App.js                       # 主入口
/components/KpiGrid.jsx       # 独立组件
/components/CostPie.jsx       # 独立组件
/utils/colors.js              # 共享常量
```

---

## 2. 功能需求

### 2.1 核心功能

| ID | 功能 | 优先级 | 描述 |
|----|------|--------|------|
| F-01 | 多文件生成 | P0 | Worker 生成独立完整的组件文件 |
| F-02 | 文件流式输出 | P0 | 按文件逐个流式返回给前端 |
| F-03 | 共享代码抽取 | P0 | 颜色等常量抽取到 `/utils/colors.js` |
| F-04 | 错误组件替代 | P0 | 生成失败时用 ErrorCard.jsx 替代 |
| F-05 | 代码语法验证 | P1 | 后端验证生成代码的语法正确性 |
| F-06 | 动态依赖管理 | P1 | Planner 根据需求决定所需依赖 |
| F-07 | ErrorBoundary 包裹 | P1 | 运行时错误不影响其他组件 |
| F-08 | 单组件重生成 | P2 | 用户可只重新生成某个失败组件 |
| F-09 | 用户编辑保存 | P2 | 用户修改后可保存自定义版本 |

### 2.2 用户故事

**US-01: 作为用户，我希望看板生成的每个组件是独立文件**
- 接受标准：每个组件在 Sandpack 中显示为独立 Tab
- 接受标准：可以单独查看和编辑每个组件代码

**US-02: 作为用户，我希望单个组件错误不影响其他组件**
- 接受标准：组件 A 崩溃时，组件 B/C 正常渲染
- 接受标准：崩溃组件显示友好的错误提示

**US-03: 作为用户，我希望看到生成进度**
- 接受标准：流式显示 "生成组件 1/5"、"生成组件 2/5" 等进度

**US-04: 作为用户，我希望失败的组件可以单独重试**
- 接受标准：点击失败组件的"重试"按钮可单独重新生成

---

## 3. 非功能需求

### 3.1 性能

- 单个组件生成时间 < 10s
- 完整看板生成时间 < 30s (5个组件并行)
- 流式首字节时间 < 2s

### 3.2 可靠性

- 组件生成成功率 > 95%
- 语法验证准确率 > 99%

### 3.3 兼容性

- Sandpack React 模板兼容
- 支持 recharts、lucide-react、date-fns 等库

---

## 4. 约束条件

### 4.1 技术约束

- 文件扩展名统一使用 `.jsx`
- 组件必须使用 `export default` 导出
- 颜色常量统一从 `/utils/colors.js` 导入

### 4.2 业务约束

- ✅ **全新实现**，不需要向后兼容
- 旧的单文件模式将被完全替换
- 前端同步适配新格式

---

## 5. 验收标准

### 5.1 P0 功能验收

- [ ] 生成的文件结构符合设计规范
- [ ] 每个组件文件可独立通过语法检查
- [ ] 流式输出每个文件给前端
- [ ] 失败组件显示 ErrorCard 替代

### 5.2 P1 功能验收

- [ ] Planner 正确生成依赖列表
- [ ] 语法错误在后端被检测并报告
- [ ] ErrorBoundary 正确隔离组件错误

### 5.3 P2 功能验收

- [ ] 可单独重新生成指定组件
- [ ] 用户编辑的代码可保存
