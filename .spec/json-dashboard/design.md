# JSON æ•°æ®é©±åŠ¨çœ‹æ¿ç”Ÿæˆ - æŠ€æœ¯è®¾è®¡

## 1. æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·æµç¨‹                                    â”‚
â”‚                                                                          â”‚
â”‚   1. ä¸Šä¼  JSON â”€â”€â†’ 2. è‡ªåŠ¨åˆ†æ Schema â”€â”€â†’ 3. å¯¹è¯ç”Ÿæˆ â”€â”€â†’ 4. é¢„è§ˆçœ‹æ¿   â”‚
â”‚         â”‚                  â”‚                    â”‚              â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–¼                  â–¼                    â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           åç«¯æœåŠ¡ (æœ¬è®¾è®¡èŒƒå›´)                          â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ POST /datasets â”‚â”€â”€â–¶â”‚ SchemaAnalyzer â”‚â”€â”€â–¶â”‚ Store schema in DB     â”‚   â”‚
â”‚  â”‚   (å·²æœ‰)       â”‚   â”‚   (æ–°å¢)       â”‚   â”‚                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ POST /chat     â”‚â”€â”€â–¶â”‚ PromptBuilder  â”‚â”€â”€â–¶â”‚ LLM + StreamParser     â”‚   â”‚
â”‚  â”‚   (å¢å¼º)       â”‚   â”‚   (æ–°å¢)       â”‚   â”‚   (å·²æœ‰)               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ GET /datasets/{id}/data   (æ–°å¢ - ä¾›å‰ç«¯ fetch è°ƒç”¨)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å‰ç«¯ (å·²å®Œæˆï¼Œä¸åœ¨æœ¬è®¾è®¡èŒƒå›´)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Schema åˆ†æå™¨è®¾è®¡

### 2.1 æ•°æ®ç»“æ„

```python
from pydantic import BaseModel
from typing import Literal, Any

class FieldStats(BaseModel):
    """å­—æ®µç»Ÿè®¡ä¿¡æ¯"""
    type: Literal["string", "number", "boolean", "date", "null", "mixed", "object", "array"]
    nullable: bool = False
    
    # å­—ç¬¦ä¸²å­—æ®µ
    unique_count: int | None = None
    sample_values: list[str] | None = None  # æœ€å¤š 5 ä¸ª
    max_length: int | None = None
    
    # æ•°å€¼å­—æ®µ
    min: float | None = None
    max: float | None = None
    avg: float | None = None
    
    # åˆ†ç±»å­—æ®µ (unique_count <= 20)
    categories: list[str] | None = None
    
    # æ—¥æœŸå­—æ®µ
    date_range: tuple[str, str] | None = None

class DatasetSchema(BaseModel):
    """Level 3 ç»Ÿè®¡ Schema"""
    fields: dict[str, FieldStats]
    row_count: int
    size_bytes: int
    sample_rows: list[dict[str, Any]]  # å‰ 5 è¡Œé‡‡æ ·
```

### 2.2 Schema åˆ†æé€»è¾‘

```python
# app/core/schema_analyzer.py

def analyze_json_schema(data: list[dict] | dict, size_bytes: int) -> DatasetSchema:
    """
    åˆ†æ JSON æ•°æ®ï¼Œç”Ÿæˆ Level 3 ç»Ÿè®¡ Schema
    
    å¤„ç†é€»è¾‘ï¼š
    1. éå†æ‰€æœ‰è¡Œï¼Œæ¨æ–­æ¯ä¸ªå­—æ®µçš„ç±»å‹
    2. å¯¹æ•°å€¼å­—æ®µè®¡ç®— min/max/avg
    3. å¯¹å­—ç¬¦ä¸²å­—æ®µç»Ÿè®¡ unique å€¼ï¼Œè‹¥ <= 20 åˆ™è®°å½•æ‰€æœ‰ç±»åˆ«
    4. æå–å‰ 5 è¡Œä½œä¸ºé‡‡æ ·æ•°æ®
    """
    pass
```

### 2.3 æ•°æ®åº“ Schema å­˜å‚¨

åœ¨ç°æœ‰ `Dataset` æ¨¡å‹ä¸­æ·»åŠ  `schema` å­—æ®µï¼š

```python
# app/db/models.py - Dataset æ¨¡å‹æ‰©å±•

class Dataset(Base):
    # ... ç°æœ‰å­—æ®µ ...
    
    # æ–°å¢
    schema_info: Mapped[dict | None] = mapped_column(
        JSONB,
        nullable=True,
        comment="Level 3 ç»Ÿè®¡ Schema"
    )
```

---

## 3. Prompt æ„å»ºå™¨è®¾è®¡

### 3.1 æ•°æ®æ„ŸçŸ¥ Prompt æ¨¡æ¿

```python
# app/prompts/data_aware.py

DATA_CONTEXT_TEMPLATE = """
## ğŸ“Š ç”¨æˆ·æ•°æ®ä¸Šä¸‹æ–‡

### æ•°æ®æ¦‚è§ˆ
- **æ•°æ®é›†åç§°**: {dataset_name}
- **æ€»è¡Œæ•°**: {row_count:,} è¡Œ
- **æ–‡ä»¶å¤§å°**: {size_kb:.1f} KB
- **æ•°æ®æ¨¡å¼**: {data_mode}  # "inline" æˆ– "fetch"

### æ•°æ®ç»“æ„ (Schema)
{schema_description}

### é‡‡æ ·æ•°æ® (å‰ 5 è¡Œ)
```json
{sample_rows_json}
```

{fetch_instruction}
"""

# å½“ data_mode == "fetch" æ—¶çš„è¡¥å……æŒ‡ä»¤
FETCH_INSTRUCTION = """
### âš ï¸ æ•°æ®è·å–æ–¹å¼

ç”±äºæ•°æ®é‡è¾ƒå¤§ï¼Œè¯·åœ¨ä»£ç ä¸­ä½¿ç”¨ä»¥ä¸‹æ–¹å¼è·å–æ•°æ®ï¼š

```jsx
const [data, setData] = useState([]);
const [loading, setLoading] = useState(true);

useEffect(() => {{
  fetch("{data_url}")
    .then(res => res.json())
    .then(json => {{
      setData(json.rows);
      setLoading(false);
    }});
}}, []);
```

æ³¨æ„ï¼š
- å¿…é¡»å¤„ç† loading çŠ¶æ€
- data å˜é‡åŒ…å«å®Œæ•´çš„ {row_count:,} è¡Œæ•°æ®
- å­—æ®µç»“æ„ä¸ä¸Šè¿° Schema ä¸€è‡´
"""

# å½“ data_mode == "inline" æ—¶çš„è¡¥å……æŒ‡ä»¤  
INLINE_INSTRUCTION = """
### âœ… æ•°æ®å†…åµŒæ–¹å¼

æ•°æ®é‡è¾ƒå°ï¼Œè¯·å°†ä¸Šè¿°é‡‡æ ·æ•°æ®çš„**å®Œæ•´ç‰ˆæœ¬**ç›´æ¥å†…åµŒåˆ°ä»£ç ä¸­ï¼š

```jsx
const data = {full_data_json};
```
"""
```

### 3.2 Prompt ç»„è£…é€»è¾‘

```python
# app/core/prompt_builder.py

class DataAwarePromptBuilder:
    """
    æ ¹æ® Session ä¸­çš„ Dataset æ„å»ºå¢å¼º Prompt
    """
    
    INLINE_THRESHOLD = 10 * 1024  # 10KB
    
    async def build(self, session_id: str, user_message: str) -> str:
        """
        1. æŸ¥è¯¢ session å…³è”çš„ datasets
        2. è‹¥æœ‰ datasetï¼Œæ„å»ºæ•°æ®ä¸Šä¸‹æ–‡
        3. ä¸ç”¨æˆ·æ¶ˆæ¯ç»„åˆ
        """
        datasets = await self._get_session_datasets(session_id)
        
        if not datasets:
            return user_message  # æ— æ•°æ®ï¼Œè¿”å›åŸå§‹æ¶ˆæ¯
        
        # é€‰æ‹©æœ€æ–°çš„ datasetï¼ˆæˆ–å¯æ‰©å±•ä¸ºå¤šæ•°æ®é›†ï¼‰
        dataset = datasets[-1]
        
        data_context = self._build_data_context(dataset)
        
        return f"{data_context}\n\n## ç”¨æˆ·éœ€æ±‚\n{user_message}"
```

---

## 4. API è®¾è®¡

### 4.1 å¢å¼ºï¼šä¸Šä¼  APIï¼ˆsession_id å¯é€‰ï¼‰

```
POST /api/datasets
```

**è¯·æ±‚å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| file | File | âœ… | JSON æˆ– CSV æ–‡ä»¶ |
| session_id | string | âŒ | å…³è”çš„ä¼šè¯ IDã€‚ä¸ä¼ åˆ™è‡ªåŠ¨åˆ›å»ºæ–° session |
| name | string | âŒ | æ•°æ®é›†åç§°ï¼Œé»˜è®¤ä½¿ç”¨æ–‡ä»¶å |

**å“åº”**:
```json
{
  "id": "dataset-uuid",
  "session_id": "session-uuid",  // å§‹ç»ˆè¿”å›ï¼Œå‰ç«¯ä¿å­˜ç”¨äºåç»­å¯¹è¯
  "name": "sales_data.json",
  "size_bytes": 125000,
  "row_count": 5000,
  "data_mode": "fetch",  // "inline" (< 10KB) æˆ– "fetch" (â‰¥ 10KB)
  "schema": {
    "fields": {
      "name": {"type": "string", "unique_count": 150, "sample_values": ["å¼ ä¸‰", "æå››"]},
      "sales": {"type": "number", "min": 100, "max": 50000, "avg": 12500},
      "region": {"type": "string", "categories": ["åä¸œ", "åå—", "ååŒ—", "è¥¿å—"]},
      "date": {"type": "date", "date_range": ["2024-01-01", "2024-12-31"]}
    },
    "sample_rows": [...]
  }
}
```

### 4.2 å¢å¼ºï¼šChat APIï¼ˆæ”¯æŒ dataset_idï¼‰

```
POST /api/chat
```

**è¯·æ±‚å‚æ•°å˜æ›´**:
```python
class ChatRequest(BaseModel):
    messages: list[ChatMessage]
    session_id: str | None = None
    provider: str | None = None
    model: str | None = None
    api_key: str | None = None
    
    # æ–°å¢
    dataset_id: str | None = None  # æ˜¾å¼æŒ‡å®šæ•°æ®é›†ï¼ˆè·¨ session å¤ç”¨ï¼‰
```

**æ•°æ®é›†è§£æä¼˜å…ˆçº§**:
```
1. dataset_id ä¼ å…¥ â†’ ä½¿ç”¨æŒ‡å®šçš„æ•°æ®é›†
2. dataset_id æœªä¼  â†’ æŸ¥è¯¢ session å…³è”çš„æœ€æ–°æ•°æ®é›†
3. éƒ½æ²¡æœ‰ â†’ æ™®é€šå¯¹è¯æ¨¡å¼ï¼Œæ— æ•°æ®å¢å¼º
```

### 4.3 æ–°å¢ï¼šæ•°æ®è·å– API

```
GET /api/datasets/{dataset_id}/data
```

**ç”¨é€”**: ä¾›å‰ç«¯ fetch è°ƒç”¨ï¼Œè·å–å®Œæ•´æ•°æ®

**å“åº”æ ¼å¼**:
```json
{
  "dataset_id": "uuid",
  "name": "sales_data.json",
  "rows": [
    {"name": "å¼ ä¸‰", "sales": 12500, "region": "åä¸œ"},
    {"name": "æå››", "sales": 8900, "region": "åå—"}
  ],
  "row_count": 5000
}
```

---

## 5. System Prompt ä¿®æ”¹

### 5.1 æ–°å¢æ•°æ®è·å–è§„åˆ™

åœ¨ç°æœ‰ System Prompt ä¸­æ·»åŠ æ¡ä»¶å…è®¸ï¼š

```markdown
### 2. ä»£ç è§„èŒƒï¼ˆå¼ºåˆ¶ï¼‰

âœ… å¿…é¡»ï¼š
- ä½¿ç”¨ export default function App()
- ä½¿ç”¨ Tailwind CSS

âœ… æ•°æ®å¤„ç†ï¼ˆæ ¹æ®æ•°æ®æ¨¡å¼é€‰æ‹©ï¼‰ï¼š

**å°æ•°æ®æ¨¡å¼ (data_mode: inline)**:
- æ•°æ®å†…è”å®šä¹‰ï¼šconst data = [...]
- ç¦æ­¢ fetch / useEffect

**å¤§æ•°æ®æ¨¡å¼ (data_mode: fetch)**:
- ä½¿ç”¨ fetch + useEffect è·å–æ•°æ®
- å¿…é¡»å¤„ç† loading çŠ¶æ€
- ä½¿ç”¨æä¾›çš„ data_url

âŒ ç¦æ­¢ï¼ˆå§‹ç»ˆï¼‰ï¼š
- ReactDOM.render / createRoot
- document.getElementById / querySelector
- é™¤æ•°æ®è·å–å¤–çš„å…¶ä»–ç½‘ç»œè¯·æ±‚
```

---

## 6. é˜ˆå€¼ä¸é™åˆ¶

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `INLINE_THRESHOLD` | 10 KB | å°äºæ­¤å€¼ä½¿ç”¨å†…åµŒæ¨¡å¼ |
| `MAX_SAMPLE_ROWS` | 5 | Schema ä¸­åŒ…å«çš„é‡‡æ ·è¡Œæ•° |
| `MAX_CATEGORIES` | 20 | åˆ†ç±»å­—æ®µæœ€å¤§ç±»åˆ«æ•°ï¼ˆè¶…è¿‡ä¸æšä¸¾ï¼‰ |
| `MAX_SAMPLE_VALUES` | 5 | å­—ç¬¦ä¸²å­—æ®µçš„é‡‡æ ·å€¼æ•°é‡ |
| `SCHEMA_TOKEN_BUDGET` | ~2000 | Schema æè¿°çš„é¢„ä¼° token å¼€é”€ |

---

## 7. é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| JSON è§£æå¤±è´¥ | è¿”å› 400ï¼Œæç¤ºæ ¼å¼é”™è¯¯ï¼ˆå·²æœ‰ï¼‰ |
| æ•°æ®ä¸ºç©º | è¿”å› 400ï¼Œæç¤ºç©ºæ•°æ® |
| Schema åˆ†æè¶…æ—¶ | 5 ç§’è¶…æ—¶ï¼Œè¿”å›åŸºç¡€ Schema |
| Fetch API 404 | å‰ç«¯æ˜¾ç¤º"æ•°æ®ä¸å­˜åœ¨" |
| CORS é”™è¯¯ | æ£€æŸ¥é…ç½®ï¼Œè¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯ |

